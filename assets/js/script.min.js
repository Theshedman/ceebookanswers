import { baseUrl } from "./utils";

const phoneInput = document.querySelector('#verify-subscription-phone'),
  submitBtn = document.querySelector('#verify-subscription-btn'),
  verifiedMessage = document.querySelector('#verified-message'),
  verifiedPhone = document.querySelector('#verified-phone'),
  phoneTitle = document.querySelector('#phone-title'),
  verifiedSubjects = document.querySelector('#verified-subjects'),
  subjectTitle = document.querySelector('#subject-title');

function fetchApiBtn(e) {
  e.preventDefault(), fetchApi();
}

function fetchApiEnter(e) {
  'Enter' === e.key && (e.preventDefault(), fetchApi());
}

async function fetchApi() {
  const e = phoneInput.value;
  phoneInput.value = '';
  const t = `${baseUrl}/candidates/verifySubscription/${e}`;
  try {
    const e = await fetch(t), n = await e.json();
    if (n.error) throw phoneTitle.classList.add('d-none'), subjectTitle.classList.add('d-none'), new Error(n.error.message);
    phoneTitle.classList.remove('d-none'), verifiedPhone.textContent = n.data.phone, verifiedMessage.classList.remove('text-danger'), subjectTitle.classList.remove('d-none'), verifiedMessage.textContent = n.message;
    let o = '';
    n.data.subjects.map(e => {
      o += '<li>' + e + '</li>';
    }), verifiedSubjects.innerHTML = o;
  } catch (e) {
    verifiedMessage.classList.add('text-danger'), verifiedMessage.textContent = e.message, verifiedPhone.textContent = '', verifiedSubjects.innerHTML = '';
  }
}

submitBtn.addEventListener('click', fetchApiBtn), phoneInput.addEventListener('keypress', fetchApiEnter);
const phoneField = document.querySelector('#admin-phone'),
  passwordField = document.querySelector('#admin-password'),
  loginBtn = document.querySelector('#admin-login-btn');
loginBtn.addEventListener('click', async e => {
  e.preventDefault();
  const t = phoneField.value, n = passwordField.value, o = await submitLoginDetails(t, n);
  console.log(o);
});
const submitLoginDetails = async (e, t) => {
  const n = { phone: e, password: t };
  try {
    const e = await fetch(`${baseUrl}/admins/login`, {
      method: 'POST',
      mode: 'cors',
      credentials: 'same-origin',
      headers: { 'Content-Type': 'application/json' },
      redirect: 'follow',
      referrerPolicy: 'no-referrer',
      body: JSON.stringify(n)
    });
    return await e.json();
  } catch (e) {
    console.log(e.message);
  }
}, guestPhoneField = document.querySelector('#guest-phone'),
  guestPasswordField = document.querySelector('#guest-password'),
  guestLoginBtn = document.querySelector('#guest-login-btn'),
  guestLoginErrorMessage = document.querySelector('#guest-login-error-message');
guestLoginBtn.addEventListener('click', async e => {
  e.preventDefault();
  const t = guestPhoneField.value, n = guestPasswordField.value;
  guestLoginErrorMessage.textContent = '', guestLoginErrorMessage.classList.add('d-none');
  try {
    const o = await guestSubmitLoginDetails(t, n);
    if (o.error) throw new Error(o.error.message);
    window.localStorage.setItem('token', o.data.token), window.location = '../../answer-page.html';
  } catch (e) {
    guestLoginErrorMessage.classList.remove('d-none'), guestLoginErrorMessage.textContent = e.message;
  }
});
const guestSubmitLoginDetails = async (e, t) => {
  const n = { phone: e, password: t };
  try {
    const e = await fetch(`${baseUrl}/guests/login`, {
      method: 'POST',
      mode: 'cors',
      credentials: 'same-origin',
      headers: { 'Content-Type': 'application/json' },
      redirect: 'follow',
      referrerPolicy: 'no-referrer',
      body: JSON.stringify(n)
    });
    return await e.json();
  } catch (e) {
    throw new Error(e.message);
  }
};
